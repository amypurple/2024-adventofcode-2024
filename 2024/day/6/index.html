<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 6: Guard Gallivant</title>
    <style>
        body {
            background: #0f0f23;
            /*337 x 5*/
            color: #cccccc;
            font-family: "Source Code Pro", monospace;
            font-weight: 300;
            font-size: 14pt;
            min-width: 60em;
        }

        h1,
        h1 a,
        h1 span {
            display: inline-block;
            text-decoration: none;
            color: #00cc00;
            text-shadow: 0 0 2px #00cc00, 0 0 5px #00cc00;
        }

        .user {
            display: inline-block;
            padding-left: 1em;
        }

        .star-count {
            color: #ffff66;
        }

        article {
            max-width: 45em;
        }

        article em {
            color: #ffffff;
            font-style: normal;
            text-shadow: 0 0 5px #ffffff;
        }

        article em.star {
            color: #ffff66;
            font-style: normal;
            text-shadow: 0 0 5px #ffff66;
        }

        img {
            border: 0;
        }

        a {
            outline: 0;
        }

        a {
            text-decoration: none;
            color: #009900;
        }

        a:hover,
        a:focus {
            color: #99ff99;
        }

        main,
        figure,
        figcaption {
            display: block;
        }

        pre,
        code {
            font-family: "Source Code Pro", monospace;
        }

        pre {
            border: 1px solid #333340;
            background: #10101a;
            display: inline-block;
            padding: 2px 5px;
        }        
    </style>
</head>

<body>
    <h1>DAY 6 - Guard Gallivant</h1>
    <article>
        <p>Solved by
        <div class="user">Amy Bienvenu <span class="star-count">12*</span></div>
        </p>
        <p>Collect stars by solving puzzles. Two puzzles will be made available on each day in the Advent calendar; the
            second puzzle is unlocked when you complete the first. Each puzzle grants <em class="star">one star</em>.
            Good luck!</p>
        <p>You still have to be careful of time paradoxes, and so it will be important to avoid anyone while The
            Historians search for the Chief. A single guard is patrolling this part of the lab.
            You start by making a map (your puzzle input) of the situation. For example:</p>
        <pre><code>....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...</code></pre>
        <p>Lab guards follow a very strict patrol protocol which involves repeatedly following these steps:</p>
        <ul>
            <li>If there is something directly in front of you, turn right 90 degrees.</li>
            <li>Otherwise, take a step forward.</li>
        </ul>
        <p>By predicting the guard's route, you can determine which specific positions in the lab will be in the patrol
            path. <em>Including the guard's starting position</em>, the positions visited by the guard before leaving
            the area are marked with an <code>X</code>:</p>
        <pre><code>....#.....
....XXXXX#
....X...X.
..#.X...X.
..XXXXX#X.
..X.X.X.X.
.#XXXXXXX.
.XXXXXXX#.
#XXXXXXX..
......#X..</code></pre>
        <p>Look at the <a href="input.data.txt">raw data</a>.</p>
        <p>Response A : <code><em id="response-a"></em></code></p>
        <p>Returning after what seems like only a few seconds to The Historians, they explain that the guard's patrol
            area is simply too large for them to safely search the lab without getting caught.</p>
        <p>Fortunately, they are <em>pretty sure</em> that adding a single new obstruction <em>won't</em> cause a time
            paradox. They'd like to place the new obstruction in such a way that the guard will get <em>stuck in a
                loop</em>, making the rest of the lab safe to search.</p>
        <pre><code>....#.....
....+---+#
....|...|.
..#.|...|.
....|..#|.
....|...|.
.#.<em>O</em>^---+.
........#.
#.........
......#...</code></pre>
        <p>You need to get the guard stuck in a loop by adding a single new obstruction. <em>How many different
                positions could you choose for this obstruction?</em></p>
        <p>Response B : <code><em id="response-b"></em></code></p>
    </article>
</body>
<script>
    const rawinput = `...............................#.........#............#...#.............................#....................#.....#........##....
..##..##.#.#....................##....#..#.....#...............#..#.....#.....................#...#.............#...#...#.........
...................#............#..................................................#............................#..#..............
............#...................................................#.........................#..#....#....................#..........
.#...........#...............................#..#....................................#............#.#............#................
.........................#..........................................#.................#...#.....#.#...............................
..#..................#......................................#......#........#.......#..........#.........#..#.........#...........
..........#..............#....................................#................................................#........#........#
..#...............................................................................................................#.#..#..........
....#....................##...................#..#....#....#.........#.......#.....................................#..............
........#...................#.......#.........................................#.........#........#....................#...........
................................................................#.......#......#...........#................#.....................
...........................................#.............#...........##.#................................#...................#....
............................#......#........#...#.................................................................................
.......#.............#...............................#.............................................#.............#.........#......
......................................................#.........................#....#................................#...........
...............#...........................................#..........#.........#..#..................#...........................
.....................................##...#................................#..#......................#.......#..........#.........
..............#.......#....................#.....................................................#.......#...................##..#
...............................................#.............#..#...#.....#..................................................#....
.....................................#........#...........................................................#......#................
........##............#...............................#....#......................................................................
.....#............#...................................................................#.............................#.............
........#...............#......#..........#........#.....#........#..........#...............................................#..#.
..................#.............#........#......#.................................................#..........................#....
.................................#............#...............................................................#..##...............
......................................#.#...........#........#.................................................................#..
...........#...........#..............#..#.#...........#............................................#...#.....................#...
....##......................#..........#..............#.............#.....#............................#....................#.....
..................#...................#..........#............................................#...#.....................#.........
.....................#...........#.........................................................#......................................
.#..............#....#..#.#...##.........#....#.............#..........#.......#...#.............................#.........#...#..
..................#...............#.....................#..#.....................#........#.......................................
......#..#......#...#..................##.............#...................#.....#.....#................................#........#.
....................#.#................#....#..................................................#............#................#....
...........................#..#.#......#........................#......#..........................................................
..#.#...............................................................#.#........................#.....................#..#.........
...#..............................#......................................................#...#....................#.#.............
....................#.......#...........#.....#.......................#........#...........................##.....................
............#.........................................................#..............................................#.........#..
..................#.#..............................#......#..................................#..........#......#..#...............
....##................#.#..................#.....#...........................................#.......................##...........
......#...........................#......#.......#..........#................#..#......#..........#..............#..#.............
........#.................#...#.........................................#..........#.........#...................................#
.#..........#....#.....#.............#...........#..................#.................#...#.......................................
...........................................................#......#...#...........................................##........#....#
............#.............................................................................#..........................#............
.........#..............................................................................................#.........#.....#......#..
.........#.......................................................................#........................#..#.....#.#............
............................#.............#..........#..#...........#......#..............#..........................#............
..#.#............#.........#.........#..................#.......................#............................................#....
...#......................#......................................................#...........#..........................#.........
.#....#...............................................................................................................#...........
.#..#................#................................................................#....^.................#.............#......
........................................................................................#.....................#...................
........##................#.............................#.........................................................................
.#.#.................#.....................#.....................#..........................#.................#...............#...
........#....................................................................................................#....................
##......#.............................#.......#........................................................................#.....##...
..........#..........................................#.................#.....#............................................#.......
......................#........................#.......................................#............#.............................
.............................#.#.......................................................................................#..........
...#.........#.....#........................#.................#...........#.....................#.................................
.........#...........................................................................#...........................#................
......#...#............#..........#........................#...................#...........#................................#.....
.....#...#....#..........................................................#......................#.....................#..........#
#.............#....................#...............................#.......#.#.............#.....................#.............#..
............................................................#.......#...................#.................................#......#
...#..#......................................#.........................................#..#.#.......##.......#............#..#....
.....#.#...#...#.#................................................................................................................
...............................................................................#........#...................#..#.........#....#...
......#.........#.............#........................................................................................#.##.......
.......................#...................................................................................................#......
.........................................................#....................................#...................##.........#....
.#..............#.#.#.............................#........................#........................#...................#.#.......
.........#.....#..........................................................................#.................#.................#...
.........#..............#...............................#.........#......#.#......................................................
......................................................................................................#....#............#.......#.
.....#.................#.......#.....#..................................#...............................................#.........
...............................................................#.............#.................................................#..
...#.....................................................................#...#.......#......#.....................................
.................................#...#.#............................................................#...#.........................
...........#..#.................................#....#...................#.............#.........#................................
..................................................#..#...........#...........................#....................................
.....#.....................................#......#......#...........................................................#............
..............#..........................................#.........#.............#..#............................#................
..........................................................................#..........#.......................#....................
.......##................#................................................................................................#.......
.#.....#.....#..................#............#......#............................#.........#......................................
..##....#..................................................................................................................#......
.......#......................#..................#...#.....................................#............#..............#..........
...............................#................#...#.................................##......................#...................
...............#..............................................................................................#.....##.......#....
................................#..........#........................................#..#..........................................
..................................................#.................................................................#.............
....................#....#.....................#.................................#.........#.....#......#......................#..
................#.............#............#................#........................................................#..........#.
.#.......#......##...................#....#..............................................................#.................#......
.........#.#............................................................................#........................#................
...............#........##.....#.....................................#..#...........#......#......................................
......#.............................................###..#.........#..............#...........................#.......#...........
.....................................#.........#...........................................................##.....................
.#....#.......................#.........#................................................................................#..#.....
....#..#.......................................................................................................##............#....
..#...................................#....#......#....................#...............................#..........................
...................#....##........................................##..........................................#...................
..........#.........#.............................................................#..#.........#...#............#.......#..#......
....#...........#...##.........................#......................#.........#..#..............................................
....................#.....#.....................................#...............................................................#.
.........#.......................#.................#...#....................................................#.#......#........#...
.................#.................................#..#..............#..........#...#.........#........#.##....##.................
.............#...........................#......................#.......................#.........................................
...............#.....#......#........#....#.......................................#.............................#.................
.............#.....##.........#...#...............................................................................................
.................................................................................#.............#.....#...#..#.....................
.................................#......#.#...#.......#......................................#......#..........................#..
#..#....................................#..#......................................................................................
...#......#.......................#..........................#...........#.#................#.#.......#...........................
#....#...............#..........................#....................#....#................................#............##........
...........#........................#..........#......................................#...................................#.....#.
......#................................#................#.............................#.........#...#........#....................
.............#................#...........#.#...........#.......................................#...........#.#...................
.....#......................#..........................#.................................#.............#............#....#........
.....#.........#.#..............................................................................#...................##............
......#.....#..#.............#...............#......#..#.#.................................#...............#...#..................
....................#.......................#...................#........................#...................#..#.....##..........
...............#...........#..#...........................................#........................#....#.........................
.....................................#...................#.#............#......................................#..................
.....#......................#.#....................#.............................................#...........................#..#.
..........#........#................#.........#...........................................#....#..#...........#..####..........#..`;

    const testinput = `....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...`;

    const dx = [0, 1, 1, 1, 0, -1, -1, -1];
    const dy = [-1, -1, 0, 1, 1, 1, 0, -1];

    var grid;
    var visitedGrid;
    var visitedTiles = [];
    var loopTiles = [];
    var maxHorizontal;
    var maxVertical;


    const dir_X = [0, 1, 0, -1];
    const dir_Y = [-1, 0, 1, 0];
    var guard_StartY; var guard_StartX;
    var guard_Y; var guard_X; var guard_Direction;

    function stringTo2DArray(input) {
        const lines = input.split('\n');
        maxVertical = lines.length;
        maxHorizontal = lines[0].length;
        grid = lines.map(line => line.split(''));
        initializeVisitedGrid();
    }

    function initializeVisitedGrid() {
        visitedGrid = Array(maxVertical).fill(null).map(() => Array(maxHorizontal).fill('.'));
    }

    function findGuard() {
        let i;
        let j;
        for (i = 0; i < maxHorizontal; i++) {
            for (j = 0; j < maxVertical; j++) {
                if (grid[j][i] == '^') {
                    guard_Y = j;
                    guard_X = i;
                    guard_Direction = 0;
                }
            }
        }
    }

    function resetGuardPosition() {
        guard_X = guard_StartX;
        guard_Y = guard_StartY;
        guard_Direction = 0;
    }

    function markAsVisited() {
        visitedGrid[guard_Y][guard_X] = 'X';
        visitedTiles.push({ x: guard_X, y: guard_Y });
    }
    function removeStartingPoint() {
        visitedGrid[guard_StartY][guard_StartX] = '.';
    }

    function moveGuard(trace = true) {
        if (trace) markAsVisited();
        let tempX = guard_X + dir_X[guard_Direction];
        let tempY = guard_Y + dir_Y[guard_Direction];
        if (tempX < 0 || tempX >= maxHorizontal || tempY < 0 || tempY >= maxVertical) return false;
        while (grid[tempY][tempX] == '#') {
            guard_Direction = (guard_Direction + 1) % 4;
            tempX = guard_X + dir_X[guard_Direction];
            tempY = guard_Y + dir_Y[guard_Direction];
        }
        guard_Y = tempY;
        guard_X = tempX;
        return true;
    }

    function simulateGuard() {
        resetGuardPosition();
        let steps = 1;
        while (moveGuard(false)) {
            if (steps > totalVisited * 2.25) break;
            steps++;
        }
        return (steps > totalVisited * 2.25);
    }

    function outputGrid() {
        let i;
        let j;
        for (j = 0; j < maxVertical; j++) {
            let line = "";
            for (i = 0; i < maxHorizontal; i++) {
                line += grid[j][i];
            }
            console.log(line);
        }
    }

    function countVisitedTiles() {
        let result = 0;
        let i;
        let j;
        for (j = 0; j < maxVertical; j++) {
            for (i = 0; i < maxHorizontal; i++) {
                if (visitedGrid[j][i] == 'X') result++;
            }
        }
        return result;
    }

    function detectLoopTiles() {
        const loopTileSet = new Set();
        visitedTiles.forEach(tile => {
            resetGuardPosition();
            grid[tile.y][tile.x] = '#';
            if (simulateGuard()) {
                const tileKey = `${tile.x},${tile.y}`;
                loopTileSet.add(tileKey);
            }
            grid[tile.y][tile.x] = '.';
        });
        loopTiles = Array.from(loopTileSet).map(key => {
            const [x, y] = key.split(',').map(Number);
            return { x, y };
        });
    }

    stringTo2DArray(rawinput);
    findGuard();
    guard_StartX = guard_X;
    guard_StartY = guard_Y;
    while (moveGuard());
    var totalVisited = countVisitedTiles();
    let result = totalVisited;
    removeStartingPoint();
    detectLoopTiles(totalVisited);
    let result2 = loopTiles.length;

    // PART ONE
    document.getElementById('response-a').innerText = result;

    // PART TWO
    document.getElementById('response-b').innerText = result2;
</script>

</html>